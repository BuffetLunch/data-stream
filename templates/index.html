{% extends "base.html" %}
{% load staticfiles %}

{% block title %}Realtime Example{% endblock %}
{% block header_text %}Realtime Example{% endblock %}

{% block extra_head %}
    <script src="{% static "js/reconnecting-websocket.min.js" %}" type="text/javascript"></script>
{% endblock %}

{% block content %}
    <h3 class="text-primary p-3">Datatable with Rest API & Websockets</h3>
    <table id="data" class="table table-striped table-bordered" style="width:100%" data-server-side="true"
           data-ajax="/api/data/?format=datatables">
        <thead>
        <tr>
            <th data-data="id">id</th>
            <th data-data="information">Information</th>
            <th data-data="a">Variable</th>
            <th data-data="x">Value</th>
        </tr>
        </thead>
    </table>
{% endblock %}


{% block extra_body %}
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <script src="//cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#data').DataTable();
        });
        $(function () {
            // Correctly decide between ws:// and wss://
            var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
            var ws_path = ws_scheme + '://' + window.location.host + "/data/stream/";
            console.log("Connecting to " + ws_path);
            var socket = new ReconnectingWebSocket(ws_path);
            console.log(socket);

            // Handle incoming messages
            socket.onmessage = function (message) {
                // Decode the JSON
                console.log("Got websocket message " + message.data);
                var data = JSON.parse(message.data);
                // Handle errors
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // If content received from the websocket
                if (data.content) {
                    $("#data").append(data.content);
                } else {
                    console.log("Cannot handle message!");
                }
            };

            // Subscribe or not to Realtime
            $("#realtime").click(function () {
                var realtime = $(this).attr("data-realtime-active");
                if (realtime == "True") {
                    console.log("Realtime Deactivation");
                    // Deactivate room
                    $(this).removeClass("btn-success");
                    $(this).addClass("btn-secondary");
                    socket.send(JSON.stringify({
                        "command": "unsubscribe"
                    }));
                    $(this).attr("data-realtime-active", "False");
                } else {
                    console.log("Realtime Activation");
                    $(this).removeClass("btn-secondary");
                    $(this).addClass("btn-success");
                    socket.send(JSON.stringify({
                        "command": "subscribe"
                    }));
                    $(this).attr("data-realtime-active", "True");
                }
            });

            // Helpful debugging
            socket.onopen = function () {
                console.log("Connected to realtime socket");
            };
            socket.onclose = function () {
                console.log("Disconnected from realtime socket");
            }
        });
    </script>
{% endblock %}
